<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>奖金计算</title>
<style>
	body {
		font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
		background-image: url("https://images.pexels.com/photos/628241/pexels-photo-628241.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1");
		width:100%;
		background-size:100%;
		margin: 0;
		padding: 40px;
		color: #333;
	}
	.container {
		max-width: 700px;
		margin: auto;
		padding: 30px;
		background-image: url("https://images.pexels.com/photos/373394/pexels-photo-373394.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1");
		width:100%;
		background-size:100%;
		color: #222; /* 统一文本颜色为深色 */
		text-shadow: 0 1px 2px rgba(255, 255, 255, 0.6); /* 添加浅色文字阴影增强对比 */
		border-radius: 16px;
		box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
		transition: all 0.3s ease-in-out;
	}
	h1 {
		text-align: center;
		color: #2c3e50;
		margin-bottom: 10px;
	}
	h5 {
    		text-align: center;
    		color: #d9534f;
    		margin: 5px 0;
    		font-weight: normal;
	}
	.file-input {
		margin: 30px 0 20px;
		text-align: center;
	}
	label {
		font-weight: bold;
		display: block;
		margin-bottom: 10px;
		font-size: 16px;
	}
	input[type="file"] {
		padding: 12px;
		border: 2px dashed #007bff;
		border-radius: 10px;
		background-color: #f0f8ff;
		cursor: pointer;
		transition: all 0.3s ease;
	}
	input[type="file"]:hover {
		background-color: #e6f0ff;
	}
	.buttons {
		display: flex;
		justify-content: space-between;
		gap: 20px;
		margin: 20px 0;
	}
	.buttons button {
		flex: 1;
		padding: 12px 0;
		border: none;
		background: linear-gradient(to right, #28a745, #218838);
		color: white;
		font-size: 16px;
		border-radius: 10px;
		cursor: pointer;
		box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
		transition: all 0.3s ease;
	}
	.buttons button:hover {
		background: linear-gradient(to right, #218838, #1e7e34);
		transform: translateY(-2px);
	}
	.buttons button[disabled] {
		background: #cccccc;
		box-shadow: none;
		cursor: not-allowed;
	}
	#output-box {
		width: 100%;
		height: 180px;
		font-family: monospace;
		font-size: 14px;
		color: #333;
		border-radius: 8px;
		border: 1px solid #007bff;
		resize: none;
		box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.05);
		white-space: pre-wrap;
		overflow-y: auto;
	}
	.copy-container {
		margin-top: 10px;
		text-align: right;
	}
	#copy-btn {
		padding: 8px 20px;
		font-size: 14px;
		border: none;
		border-radius: 10px;
		background: linear-gradient(to right, #007bff, #0056b3);
		color: white;
		cursor: pointer;
		box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
		transition: all 0.3s ease;
	}
	#copy-btn:hover:not([disabled]) {
		background: linear-gradient(to right, #0056b3, #003d7a);
		transform: translateY(-2px);
	}
	#copy-btn[disabled] {
		background: #cccccc;
		box-shadow: none;
		cursor: not-allowed;
	}
</style>
</head>
<body>
<div class="container">
	<h1>奖金计算</h1>
	<div class="file-input">
	<h5>注意:如果存在充值1630升级临时工的成员，请生成后并删除。如无则正常使用</h5>
        <h5>正确的格式为后缀:xlsx/xls</h5>
		<label for="file-upload">请上传 Excel 文件 (.xlsx)(.xls):</label>
		<input type="file" id="file-upload" accept=".xlsx,.xls" />
	</div>
	<div class="buttons">
		<button id="add-btn" disabled>新增奖金</button>
		<button id="upgrade-btn" disabled>升级奖金</button>
	</div>
	<textarea id="output-box" readonly></textarea>
	<div class="copy-container">
		<button id="copy-btn" disabled>复制结果</button>
	</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script>
	let excelData = [];
	let headers = {};

	const addBtn = document.getElementById('add-btn');
	const upgradeBtn = document.getElementById('upgrade-btn');
	const copyBtn = document.getElementById('copy-btn');
	const outputBox = document.getElementById('output-box');

	// 处理文件上传
	document.getElementById('file-upload').addEventListener('change', function (event) {
		const file = event.target.files[0];
		if (!file) return;

		const reader = new FileReader();
		reader.onload = function (e) {
			const data = e.target.result;
			const workbook = XLSX.read(data, { type: 'binary' });
			const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
			excelData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

			// 解析表头
			const headerRow = excelData[0];
			headers = {
				会员账号: headerRow.indexOf("会员账号"),
				金额: headerRow.indexOf("金额"),
				状态: headerRow.indexOf("状态"),
				是否首充: headerRow.indexOf("是否首充"),
				会员等级: headerRow.indexOf("会员等级")
			};

			// 启用按钮
			addBtn.disabled = false;
			upgradeBtn.disabled = false;
		};
		reader.readAsBinaryString(file);
	});

	// 新增奖金按钮逻辑
	addBtn.addEventListener('click', function () {
		const superiorBonus = { "S1": 163, "S2": 4350, "S3": 14850, "S4": 46850, "S5": 115000 };
		const usernameBonus = { "S1": 163, "S2": 3480, "S3": 11880, "S4": 37480, "S5": 92000 };
		const bonusEntries = [];

		excelData.forEach(row => {
			if (row[headers['是否首充']] === "是") {
				const level = row[headers['会员等级']];
				const username = row[headers['会员账号']].match(/用户名：(\d+)/)?.[1];
				const superior = row[headers['会员账号']].match(/我的上级：(\d+)/)?.[1];
				if (level && username && superior) {
					bonusEntries.push(`${username}+${usernameBonus[level]}`);
					bonusEntries.push(`${superior}+${superiorBonus[level]}`);
				}
			}
		});

		outputBox.value = bonusEntries.join('\n');
		copyBtn.disabled = bonusEntries.length === 0;
		alert("新增奖金计算完成！");
	});

	// 升级奖金
	upgradeBtn.addEventListener('click', function () {
		outputBox.value = ''; // 清空之前的内容

		const userHasFirstCharge = new Set(); // 存储所有有“首充”的用户名
		const userPayments = {};  // 用户名 => { totalAmount, level }

		// 第一步：找出哪些用户名有“首充”
		excelData.forEach(row => {
			const username = row[headers['会员账号']]?.match(/用户名：(\d+)/)?.[1];
			if (!username) return;

			if (row[headers['是否首充']] === "是") {
				userHasFirstCharge.add(username);
			}
		});

		// 第二步：统计无首充用户的付款总额，并记录等级
		excelData.forEach(row => {
			const username = row[headers['会员账号']]?.match(/用户名：(\d+)/)?.[1];
			const level = row[headers['会员等级']];  // 获取会员等级（S2, S3, S4, S5）
			if (!username || userHasFirstCharge.has(username)) return; // 有首充的跳过

			if (row[headers['状态']] === "已通过" && row[headers['是否首充']] === "否") {
				const amountStr = row[headers['金额']];
				const amount = parseFloat(amountStr.replace("充值金额：", "")) || 0;

				if (!userPayments[username]) {
					userPayments[username] = { totalAmount: 0, level };
				}
				userPayments[username].totalAmount += amount;
			}
		});

		// 等级映射：根据金额范围对应的基础等级
		const levelMap = {
			"2000-12000": "S2",
			"15000-36000": "S3",
			"40000-130000": "S4",
			"150000-300000": "S5"
		};

		// 对应的奖励金额
		const rewardMap = {
			"S2": 4350,
			"S3": 14850,
			"S4": 46850,
			"S5": 115000
		};

		// 定义等级的排序，用于比较大小
		const levelOrder = { "S1": 1, "S2": 2, "S3": 3, "S4": 4, "S5": 5 };

		const results = [];

		for (const [username, { totalAmount, level }] of Object.entries(userPayments)) {
			let baseLevel = "";
			if (totalAmount >= 2000 && totalAmount <= 12000) baseLevel = "S2";
			else if (totalAmount >= 15000 && totalAmount <= 36000) baseLevel = "S3";
			else if (totalAmount >= 40000 && totalAmount <= 130000) baseLevel = "S4";
			else if (totalAmount >= 150000 && totalAmount <= 300000) baseLevel = "S5";

			// 比较等级，取最高的奖励等级
			let rewardLevel = baseLevel;
			if (levelOrder[level] > levelOrder[baseLevel]) {
				rewardLevel = level;
			}

			if (rewardLevel) {
				results.push(`${username}+${rewardMap[rewardLevel]}`);
			}
		}

		outputBox.value = results.join('\n');
		copyBtn.disabled = results.length === 0;
		alert("升级奖金计算完成！");
	});

	// 复制按钮逻辑
	copyBtn.addEventListener('click', () => {
		const text = outputBox.value.trim();
		if (!text) {
			alert('没有可复制的内容');
			return;
		}
		navigator.clipboard.writeText(text).then(() => {
			alert('复制成功！');
		}).catch(() => {
			alert('复制失败，请手动复制');
		});
	});
</script>
</body>
</html>
